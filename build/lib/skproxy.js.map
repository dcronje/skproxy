{"version":3,"sources":["../../src/lib/skproxy.js"],"names":[],"mappings":"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","file":"skproxy.js","sourcesContent":["import http from 'http';\nimport httpProxy from 'http-proxy';\nimport path from 'path';\nimport fs from 'fs';\nimport { vlaidate as jsonVal } from 'jsonschema';\nimport * as _ from 'underscore';\nimport Promise from 'bluebird';\n\n//TODO: add target to proxy (get rid of proxy.proxy.options.target.host) object manually assign target proxy server and set up try catch / on error\nclass SkProxy {\n\n\tlisteningPort = null;\n\tproxies = [];\n\tserver = null;\n\n\tconstructor(port = 80) {\n\t\tthis.listeningPort = port;\n\t}\n\n\tstartServer() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tvar schemaDir = path.resolve(path.dirname(module.filename), '../', 'schema');\n\t\t\tthis.server = http.createServer((req ,res) => {\n\t\t\t\tvar proxy = _.find(this.proxies, (proxyItem) => {\n\t\t\t\t\tvar reqUri = req.headers.host.split(':')[0];\n\t\t\t\t\treturn proxyItem.listen.host == reqUri;\n\t\t\t\t});\n\t\t\t\tif (proxy) {\n\t\t\t\t\tproxy.proxy.proxyRequest(req, res);\n\t\t\t\t} else {\n\t\t\t\t\tvar responseObject = JSON.stringify({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Api/Site not found',\n\t\t\t\t\t\tdata: false\n\t\t\t\t\t});\n\t\t\t\t\tres.writeHead(404, {\n\t\t\t\t\t\t'Content-Length': responseObject.length,\n\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t});\n\t\t\t\t\tres.write(responseObject);\n\t\t\t\t\tres.end();\n\t\t\t\t\tlog.warning('Unable to proxy: '+req.headers.host+':'+_proxy.listeningPort);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.server.on('upgrade', (req, socket, head) => {\n\t\t\t\tvar proxy = _.find(this.proxies, (proxyItem) => {\n\t\t\t\t\tvar reqUri = req.headers.host.split(':')[0];\n\t\t\t\t\treturn proxyItem.listen.host == reqUri;\n\t\t\t\t});\n\t\t\t\tif (proxy) {\n\t\t\t\t\tproxy.proxy.proxyRequest(req, res);\n\t\t\t\t} else {\n\t\t\t\t\tvar responseObject = JSON.stringify({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Api/Site not found',\n\t\t\t\t\t\tdata: false\n\t\t\t\t\t});\n\t\t\t\t\tres.writeHead(404, {\n\t\t\t\t\t\t'Content-Length': responseObject.length,\n\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t});\n\t\t\t\t\tres.write(responseObject);\n\t\t\t\t\tres.end();\n\t\t\t\t\tlog.warning('Unable to proxy: '+req.headers.host+':'+this.listeningPort+' (socket)');\n\t\t\t\t}\n\t\t\t});\n\t\t\tlog.message('Starting proxy server on port: '+this.listeningPort);\n\t\t\tthis.server.listen(this.listeningPort);\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tloadConfig(jsonConf) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!jsonConf || !jsonConf instanceof Object) {\n\t\t\t\treturn reject(new Error('Missing config object'));\n\t\t\t}\n\t\t\tvar proxyConf = jsonConf;\n\t\t\tvar schema = fs.readFileSync(this.schemaDir+'/configSchema.json');\n\t\t\tvar errors = jsonVal(proxyConf, schema).errors;\n\t\t\tif (errors.length) {\n\t\t\t\tvar errorString = 'Invalid json object, the following errors were found in your json object: ';\n\t\t\t\tfor (var e = 0; e < errors.length; e ++) {\n\t\t\t\t\terrorString += '('+(e + 1)+'): '+errors[e].stack+' ';\n\t\t\t\t}\n\t\t\t\treturn reject(new Error(errorString));\n\t\t\t}\n\t\t\tPromise.each(proxyConf.proxies, (proxy) => {\n\t\t\t\treturn this.loadProxy(proxy);\n\t\t\t})\n\t\t\t.then(() => {\n\t\t\t\tresolve();\n\t\t\t})\n\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\tloadProxy(proxyConf) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (proxyConf.target.port === undefined || proxyConf.target.port == null || parseInt(proxyConf.target.port) < 80) {\n\t\t\t\tproxyConf.target.port = 80;\n\t\t\t}\n\t\t\tvar proxy = new httpProxy.createProxyServer({\n\t\t\t\ttarget: {\n\t\t\t\t\thost: proxyConf.target.host,\n\t\t\t\t\tport: proxyConf.target.port\n\t\t\t\t}\n\t\t\t});\n\t\t\tproxy.on('error', (error, req, res) => {\n\t\t\t\tvar responseObject = JSON.stringify({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: error,\n\t\t\t\t\tdata: false\n\t\t\t\t});\n\t\t\t\tres.writeHead(404, {\n\t\t\t\t\t'Content-Length': responseObject.length,\n\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t});\n\t\t\t\tres.write(responseObject);\n\t\t\t\tres.end();\n\t\t\t\tlog.error(_error+': '+_proxyConf.listen.host+':'+_proxy.listeningPort+req.url+' >>> '+_proxyConf.target.host+':'+_proxyConf.target.port+req.url)\n\t\t\t});\n\t\t\tproxy.on('proxyRes', (proxyRes, req, res) => {\n\t\t\t\tlog.message('Proxied: '+_proxyConf.listen.host+':'+_proxy.listeningPort+req.url+' >>> '+_proxyConf.target.host+':'+_proxyConf.target.port+req.url)\n\t\t\t});\n\t\t\tvar proxyItem = {\n\t\t\t\tproxy: proxy,\n\t\t\t\tlisten: proxyConf.listen,\n\t\t\t\ttarget: proxyConf.target\n\t\t\t};\n\t\t\tthis.proxies.push(proxyItem);\n\t\t\tlog.message('Started proxy: '+proxyConf.listen.host+':'+this.listeningPort+' >>> '+proxyConf.target.host+':'+proxyConf.target.port);\n\t\t\tresolve();\n\t\t});\n\t}\n}\n\nprocess.on('SIGINT', function() {\n\tconsole.log(\"\\n\");\n\tlog.warning('Stopping proxy server on port: '+_proxy.listeningPort, function() {\n\t\tprocess.exit(0);\n\t});\n});\n\nexport default SkProxy;\n"]}