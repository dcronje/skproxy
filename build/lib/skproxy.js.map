{"version":3,"sources":["../../src/lib/skproxy.js"],"names":[],"mappings":"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","file":"skproxy.js","sourcesContent":["import http from 'http';\nimport httpProxy from 'http-proxy';\nimport path from 'path';\nimport fs from 'fs';\nimport jsonSchema from 'jsonschema';\nimport * as _ from 'underscore';\nimport Promise from 'bluebird';\nimport chalk from 'chalk';\n\nlet jsonVal = jsonSchema.validate;\n\n//TODO: add target to proxy (get rid of proxy.proxy.options.target.host) object manually assign target proxy server and set up try catch / on error\nclass SkProxy {\n\n\tlisteningPort = null;\n\tproxies = [];\n\tserver = null;\n\tschemaDir = '';\n\n\tconstructor(port = 80) {\n\t\tthis.listeningPort = port;\n\t\tthis.schemaDir = path.resolve(__dirname, '../../', 'schema');\n\t}\n\n\tstartServer() {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.server = http.createServer((req ,res) => {\n\t\t\t\tvar proxy = _.find(this.proxies, (proxyItem) => {\n\t\t\t\t\tvar reqUri = req.headers.host.split(':')[0];\n\t\t\t\t\treturn proxyItem.listen.host == reqUri;\n\t\t\t\t});\n\t\t\t\tif (proxy) {\n\t\t\t\t\tproxy.proxy.web(req, res);\n\t\t\t\t} else {\n\t\t\t\t\tvar responseObject = JSON.stringify({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Api/Site not found',\n\t\t\t\t\t\tdata: false\n\t\t\t\t\t});\n\t\t\t\t\tres.writeHead(404, {\n\t\t\t\t\t\t'Content-Length': responseObject.length,\n\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t});\n\t\t\t\t\tres.write(responseObject);\n\t\t\t\t\tres.end();\n\t\t\t\t\tconsole.log(chalk.yellow('[WARNING]')+' Unable to proxy: '+req.headers.host+':'+this.listeningPort);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.server.on('upgrade', (req, socket, head) => {\n\t\t\t\tvar proxy = _.find(this.proxies, (proxyItem) => {\n\t\t\t\t\tvar reqUri = req.headers.host.split(':')[0];\n\t\t\t\t\treturn proxyItem.listen.host == reqUri;\n\t\t\t\t});\n\t\t\t\tif (proxy) {\n\t\t\t\t\tproxy.proxy.ws(req, socket, head);\n\t\t\t\t} else {\n\t\t\t\t\tvar responseObject = JSON.stringify({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Api/Site not found',\n\t\t\t\t\t\tdata: false\n\t\t\t\t\t});\n\t\t\t\t\tres.writeHead(404, {\n\t\t\t\t\t\t'Content-Length': responseObject.length,\n\t\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t\t});\n\t\t\t\t\tres.write(responseObject);\n\t\t\t\t\tres.end();\n\t\t\t\t\tconsole.log(chalk.yellow('[WARNING]')+' Unable to proxy: '+req.headers.host+':'+this.listeningPort+' (socket)');\n\t\t\t\t}\n\t\t\t});\n\t\t\tconsole.log(chalk.blue('[MESSAGE]')+' Starting proxy server on port: '+this.listeningPort);\n\t\t\tthis.server.listen(this.listeningPort);\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tloadConfig(jsonConf) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!jsonConf || !jsonConf instanceof Object) {\n\t\t\t\treturn reject(new Error('Missing config object'));\n\t\t\t}\n\t\t\tvar proxyConf = jsonConf;\n\t\t\tvar schemaFile = path.resolve(this.schemaDir, './configSchema.json');\n\t\t\tvar schema = JSON.parse(fs.readFileSync(schemaFile, 'utf-8'));\n\t\t\tvar errors = jsonVal(proxyConf, schema).errors;\n\t\t\tif (errors.length) {\n\t\t\t\tvar errorString = 'Invalid json object, the following errors were found in your json object: ';\n\t\t\t\tfor (var e = 0; e < errors.length; e ++) {\n\t\t\t\t\terrorString += '('+(e + 1)+'): '+errors[e].stack+' ';\n\t\t\t\t}\n\t\t\t\treturn reject(new Error(errorString));\n\t\t\t}\n\t\t\tPromise.each(proxyConf.proxies, (proxy) => {\n\t\t\t\treturn this.loadProxy(proxy);\n\t\t\t})\n\t\t\t.then(() => {\n\t\t\t\tresolve();\n\t\t\t})\n\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\tloadProxy(proxyConf) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (proxyConf.target.port === undefined || proxyConf.target.port == null || parseInt(proxyConf.target.port) < 80) {\n\t\t\t\tproxyConf.target.port = 80;\n\t\t\t}\n\t\t\tif (proxyConf.listen.port === undefined || proxyConf.listen.port == null || parseInt(proxyConf.listen.port) < 80) {\n\t\t\t\tproxyConf.listen.port = this.listeningPort;\n\t\t\t}\n\t\t\tvar proxy = new httpProxy.createProxyServer({\n\t\t\t\ttarget: {\n\t\t\t\t\thost: proxyConf.target.host,\n\t\t\t\t\tport: proxyConf.target.port\n\t\t\t\t}\n\t\t\t});\n\t\t\tproxy.on('error', (error, req, res) => {\n\t\t\t\tvar responseObject = JSON.stringify({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: error,\n\t\t\t\t\tdata: false\n\t\t\t\t});\n\t\t\t\tres.writeHead(404, {\n\t\t\t\t\t'Content-Length': responseObject.length,\n\t\t\t\t\t'Content-Type': 'application/json'\n\t\t\t\t});\n\t\t\t\tres.write(responseObject);\n\t\t\t\tres.end();\n\t\t\t\tlog.error(_error+': '+proxyConf.listen.host+':'+proxyConf.listen.port+req.url+' >>> '+proxyConf.target.host+':'+proxyConf.target.port+req.url)\n\t\t\t});\n\t\t\tproxy.on('proxyRes', (proxyRes, req, res) => {\n\t\t\t\tconsole.log(chalk.blue('[MESSAGE]')+' Proxied: '+proxyConf.listen.host+':'+proxyConf.listen.port+req.url+' >>> '+proxyConf.target.host+':'+proxyConf.target.port+req.url)\n\t\t\t});\n\t\t\tvar proxyItem = {\n\t\t\t\tproxy: proxy,\n\t\t\t\tlisten: proxyConf.listen,\n\t\t\t\ttarget: proxyConf.target\n\t\t\t};\n\t\t\tthis.proxies.push(proxyItem);\n\t\t\tconsole.log(chalk.blue('[MESSAGE]')+' Started proxy: '+proxyConf.listen.host+':'+proxyConf.listen.port+' >>> '+proxyConf.target.host+':'+proxyConf.target.port);\n\t\t\tresolve();\n\t\t});\n\t}\n}\n\nprocess.on('SIGINT', () => {\n\tconsole.log(\"\\n\");\n\tconsole.log(chalk.yellow('[WARNING]')+' Stopping proxy server on port: '+proxy.listeningPort, () => {\n\t\tprocess.exit(0);\n\t});\n});\n\nexport default SkProxy;\n"]}